引言

随着实时Web应用的普及，WebSocket协议已成为现代网络通信的核心技术之一。从在线聊天、协同编辑到金融交易平台，WebSocket凭借其全双工、低延迟的特性，极大提升了用户体验。然而，许多开发者在享受其便利的同时，往往忽略了WebSocket通信中的安全隐患。本文将深入探讨WebSocket的工作原理、常见攻击手法，并通过搭建DVWS漏洞靶场进行实战演练，帮助读者全面掌握WebSocket安全测试与防护技能。

一、WebSocket基础回顾

1.1 什么是WebSocket？

WebSocket是一种网络通信协议，在客户端（如浏览器）和服务器之间建立持久化连接，实现全双工数据传输。与传统的HTTP“请求-响应”模式不同，WebSocket允许服务器主动向客户端推送数据，无需客户端反复轮询。

关键特性：

· 建立在TCP之上，通过HTTP握手升级协议。
· 支持文本和二进制数据传输。
· 头部开销小，实时性高。

1.2 典型应用场景

· 网页聊天：微信网页版、Slack、Discord。
· 在线游戏：Agar.io、MMORPG网页版。
· 金融交易：Robinhood、币安实时行情。
· 协同办公：Google Docs、腾讯文档。

1.3 URI格式

WebSocket的URI与HTTP类似，分为明文和加密两种：

```
ws://host[:port]/path[?query]      # 明文，默认端口80
wss://host[:port]/path[?query]     # 加密，默认端口443
```

握手阶段仍使用HTTP协议，通过Upgrade: websocket头完成协议切换。

二、WebSocket抓包与调试

2.1 为什么需要抓包？

WebSocket通信内容在开发者工具中通常以帧（Frame）形式展示，但若要深入分析或篡改数据，则需要专门的抓包工具（如Burp Suite、Wireshark）。通过拦截WebSocket消息，我们可以：

· 查看握手请求与响应。
· 修改发送的数据帧。
· 重放消息以测试业务逻辑漏洞。

2.2 操纵WebSocket消息

在Burp Suite中，WebSocket消息会显示在“WebSocket历史”标签页。我们可以拦截并修改消息内容，例如更改聊天文本、篡改交易金额等，观察服务器响应。这常用于测试业务逻辑漏洞。

2.3 操纵WebSocket握手

握手阶段是关键，攻击者可能修改Origin、Cookie等头部。例如，若服务器未验证Origin，则可构造恶意页面发起CSWSH攻击（下文详述）。通过Burp拦截握手请求，可尝试移除或篡改这些头部，测试服务器是否进行了正确的来源校验。

三、WebSocket常见漏洞

3.1 CSWSH（跨站点WebSocket劫持）

CSWSH类似于CSRF，攻击者利用用户已认证的身份，在恶意页面中自动与目标WebSocket服务器建立连接，从而窃取或操纵用户数据。

攻击条件：

· WebSocket握手仅依赖Cookie或HTTP认证，未验证Origin。
· 无有效的CSRF令牌。

危害：攻击者可以监听服务器推送的消息，或冒充用户发送恶意指令。

3.2 XSS跨站脚本

如果WebSocket服务器将接收到的消息直接展示在页面上而未做过滤，攻击者可通过发送包含恶意脚本的消息，在受害者浏览器中执行任意JavaScript，盗取Cookie或执行其他操作。

3.3 业务逻辑漏洞

· 权限绕过：通过修改消息中的用户ID或角色，访问他人数据。
· 数据篡改：在交易、投票等场景中修改关键数值。
· 消息重放：未使用一次性令牌，导致同一消息可多次生效。

3.4 DoS攻击

WebSocket连接长期保持，攻击者可发起大量连接耗尽服务器资源，或发送超大负载导致服务崩溃。若不限制连接频率，极易被利用。

四、环境搭建：DVWS漏洞靶场

为了安全地实践WebSocket攻击，我们使用 DVWS（Damn Vulnerable WebSocket） 项目。DVWS是一个包含多种WebSocket漏洞的测试环境。

4.1 安装步骤

```bash
# 安装依赖
apt install git docker docker-compose -y

# 拉取DVWS镜像
docker pull tssoffsec/dvws

# 运行容器（映射80和8080端口）
docker run -d -p 80:80 -p 8080:8080 tssoffsec/dvws

# 修改hosts文件，将dvws.local指向本机IP
echo "127.0.0.1 dvws.local" >> /etc/hosts
```

访问 http://dvws.local 即可看到DVWS主页。该靶场提供了多个漏洞场景，包括WebSocket爆破、在线聊天等。

五、实战案例

5.1 案例一：WebSocket爆破实验（Python脚本）

场景：DVWS中有一个登录功能，通过WebSocket发送用户名和密码进行验证。我们可以编写Python脚本，利用字典进行爆破。

思路：

1. 抓包分析WebSocket握手和消息格式。
2. 使用Python的websocket-client库建立连接，发送登录消息。
3. 根据响应判断成功与否。

步骤：

· 打开DVWS的WebSocket爆破模块，用浏览器开发者工具查看消息格式。假设登录消息为JSON：{"action":"login","username":"admin","password":"123456"}。
· 安装Python库：pip install websocket-client
· 编写爆破脚本（示例）：

```python
import websocket
import threading
import time

def try_login(username, password):
    ws = websocket.WebSocket()
    ws.connect("ws://dvws.local:8080/ws_login")  # 假设连接地址
    login_msg = f'{{"action":"login","username":"{username}","password":"{password}"}}'
    ws.send(login_msg)
    result = ws.recv()
    ws.close()
    if "success" in result:
        print(f"[+] 成功: {username}:{password}")
        return True
    return False

# 从字典文件中读取
with open("passwords.txt") as f:
    for pwd in f:
        pwd = pwd.strip()
        if try_login("admin", pwd):
            break
        time.sleep(0.1)  # 避免请求过快
```

此脚本展示了如何自动化WebSocket通信，测试弱口令。实际测试中需注意请求频率，避免触发防护。

5.2 案例二：在线聊天应用（HTML+JS）与XSS

场景：DVWS提供了一个聊天室，所有用户发送的消息会广播给其他在线用户。若服务器未过滤消息内容，则存在存储型XSS漏洞。

思路：

1. 编写一个简单的HTML页面，连接WebSocket聊天服务器。
2. 发送包含JavaScript代码的消息。
3. 观察其他用户浏览器是否执行该脚本。

代码示例（HTML+JS）：

```html
<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat XSS PoC</title>
</head>
<body>
    <h2>WebSocket Chat</h2>
    <input id="msg" type="text" placeholder="输入消息">
    <button onclick="sendMsg()">发送</button>
    <div id="output"></div>

    <script>
        const ws = new WebSocket("ws://dvws.local:8080/ws_chat");
        ws.onmessage = function(event) {
            // 直接将消息插入页面，存在XSS风险
            document.getElementById("output").innerHTML += "<p>" + event.data + "</p>";
        };

        function sendMsg() {
            let msg = document.getElementById("msg").value;
            ws.send(msg);
        }
    </script>
</body>
</html>
```

攻击验证：在输入框中输入 <img src=x onerror=alert('XSS')>，如果其他用户打开该页面并接收到这条消息，就会弹出对话框，证明XSS存在。

防御：服务器应对消息进行HTML实体编码，或客户端使用textContent代替innerHTML。

六、安全防御建议

· 严格验证Origin头：服务器应检查Origin是否在白名单内，防止CSWSH。
· 使用会话绑定令牌：在握手阶段传递一次性令牌，并验证其有效性。
· 输入输出过滤：对所有WebSocket消息进行内容过滤，防范XSS。
· 连接频率限制：对单个IP或用户的连接数、消息频率进行限制，防止DoS。
· 使用WSS加密：防止中间人窃听或篡改数据。

七、总结

WebSocket为实时应用带来了革命性体验，但其安全风险不容忽视。从抓包分析到漏洞利用，本文通过理论讲解和DVWS靶场实战，展示了CSWSH、XSS、业务逻辑漏洞等常见攻击手法。安全人员应在开发测试阶段引入WebSocket安全检测，遵循最小权限原则，确保“实时”的同时也“安全”。

延伸思考：除了文中提到的方法，你是否想过利用WebSocket进行端口扫描（通过错误响应）或会话固定攻击？欢迎在DVWS中继续探索更多可能性。
