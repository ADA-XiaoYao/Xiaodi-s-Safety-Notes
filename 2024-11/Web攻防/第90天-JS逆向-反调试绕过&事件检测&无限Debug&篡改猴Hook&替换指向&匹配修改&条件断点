引言：JS逆向与Web安全

在前端安全领域，JS逆向是一个绕不开的话题。现代Web应用大量使用JavaScript进行逻辑处理，包括数据加密、签名生成、验证码计算等。通过分析前端代码，安全测试人员可以发现接口路由、加密算法、敏感信息泄露等安全隐患，从而更好地评估系统安全性。

JS逆向的应用场景非常广泛：

· 登录框加密：当登录密码被前端加密后再传输，通过逆向可获取加密方式，从而在爆破攻击中构造正确的加密数据。
· 价格篡改：若电商网站前端计算折扣，攻击者可能通过修改JS逻辑篡改价格。
· 验证码可预测：生成验证码的算法若存在缺陷，逆向后可预测验证码值。
· 签名伪造：如X-Sign等签名参数在前端生成，逆向后可模拟生成任意请求的签名。
· 参数加密测试：参数加密后，逆向算法可修改Payload进行漏洞测试。

因此，掌握JS逆向技术对于Web安全从业者至关重要。本文将理论与实践结合，从开发者工具的基础使用开始，逐步深入到实际案例分析和反调试绕过技巧。

一、开发者工具：JS逆向的瑞士军刀

浏览器的开发者工具（F12）是JS逆向的核心工具。其主要面板及功能如下：

1. F12面板概览

· 元素（Elements）：查看和修改DOM结构，可用于定位与JS交互的页面元素。
· 网络（Network）：监控所有HTTP请求，查看请求参数、响应头、Cookie等，是分析加密数据入口的关键。
· 源代码（Sources）：展示所有加载的JS、CSS、HTML文件，支持断点调试、查看调用堆栈、作用域变量等，是逆向分析的主战场。
· 控制台（Console）：执行任意JS代码，查看日志输出，常用于动态调试和验证假设。

2. 核心调试功能详解

（1）作用域（Scope）

当在Sources面板中断点暂停时，右侧的“Scope”面板会显示当前作用域内的所有变量，包括局部变量、闭包、全局变量等。通过观察变量值的变化，可以快速理解代码逻辑。

（2）调用堆栈（Call Stack）

调用堆栈记录了代码执行的路径顺序。当程序暂停时，堆栈中展示了从入口到当前断点的函数调用链。这对于追踪加密函数的调用来源、理清逻辑顺序非常有帮助。

（3）断点调试（Breakpoints）

断点是逆向的核心手段。开发者工具支持多种断点类型：

· 代码行断点：在Sources中找到目标代码行，点击行号即可设置。
· 条件断点：右键点击行号，输入条件表达式，只有条件满足时才暂停，适合在循环或大量执行中定位特定情况。
· DOM断点：在Elements面板中，右键点击元素可设置节点变化、属性修改等断点。
· XHR/fetch断点：在Sources面板右侧的“XHR/fetch Breakpoints”中，可设置拦截特定URL的AJAX请求。

参考示例：某应用登录时发送了加密的password参数，我们可以在网络面板中找到该请求，右键选择“Inspect in Sources panel”直接跳转到发起请求的代码位置，然后设置断点，重新触发登录，即可在暂停时查看调用堆栈和作用域，追踪加密函数的来源。

二、实战案例：某应用加密算法逆向分析

假设我们正在测试一个名为“DemoApp”的Web应用，其登录请求中password字段被加密。以下演示如何通过断点调试和调用堆栈分析还原加密算法。

1. 定位加密入口

打开F12 -> 网络面板，输入错误账号密码登录，找到登录请求（如/api/login）。查看请求负载，发现password是一串密文。右键请求 -> “Copy as fetch”或直接点击“Initiator”列查看调用栈。Initiator会显示发起请求的JS文件和行号，点击即可跳转到Sources面板对应位置。

2. 设置断点并重新触发

在Sources面板中找到该行，设置断点。刷新页面重新登录，程序会在该行暂停。此时观察右侧作用域，可以看到请求参数对象，但password已是加密后的值，说明加密在此之前已完成。

3. 回溯调用堆栈

查看调用堆栈，从下往上依次是函数调用顺序。点击堆栈中的上一层函数，跳转到对应代码，观察其内部逻辑。重复此过程，直到找到加密函数——通常是一个对password进行操作的函数，可能调用了一些加密库（如CryptoJS）或自定义算法。

4. 分析加密逻辑

找到加密函数后，在其内部设置断点，重新执行，观察输入输出。通过作用域查看传入的原始密码和加密后的结果，并注意加密过程中使用的密钥、IV等参数。必要时，可将相关代码复制到本地Node环境运行验证。

5. 提取JS文件全面分析

在Sources面板中，可以搜索关键词（如“encrypt”、“password”、“sign”）定位更多加密相关代码。有时加密逻辑分散在多个文件中，可以通过全局搜索（Ctrl+Shift+F）查找。

通过以上步骤，我们就能成功还原加密算法，进而构造任意密码的加密请求，进行后续安全测试。

三、反调试技术：逆向路上的绊脚石

为了防止被调试分析，开发者会采用各种反调试手段。了解这些技术及其绕过方法，是进阶逆向的必备技能。

常见的反调试检测方法

1. 无限Debugger：通过setInterval或循环中插入debugger;语句，导致调试器无限暂停，干扰分析。
   ```javascript
   setInterval(function(){debugger;}, 100);
   ```
2. 键盘监听：监听F12、Ctrl+Shift+I等开发者工具快捷键，弹出警告或直接关闭页面。
   ```javascript
   window.addEventListener('keydown', function(e){
       if(e.key === 'F12') e.preventDefault();
   });
   ```
3. 检测窗口大小或视口：开发者工具打开时会改变浏览器窗口的尺寸或某些属性，如window.outerHeight - window.innerHeight超过阈值则判断为打开。
   ```javascript
   if (window.outerHeight - window.innerHeight > 200) {
       // 检测到开发者工具
   }
   ```
4. 检测开发者工具对象：如console对象、__defineGetter__等被修改时的特征。
5. 利用console.log调用次数：在循环中大量输出，如果控制台打开，性能会下降，从而检测时间差。
6. toString检测：对函数调用toString()，若被调试器包装，返回内容可能不同。
7. 检测非浏览器环境：如navigator.webdriver属性在自动化工具中为true。

绕过技巧

针对上述反调试，我们可以采取以下策略：

· 禁用所有断点：在Sources面板中，点击“Deactivate breakpoints”按钮（或按Ctrl+F8），暂时禁用所有断点，绕过无限debugger。
· 禁用局部断点：对于特定行的debugger，可以右键选择“Never pause here”，设置永不在此暂停。
· 条件断点：将debugger所在行设为条件断点，条件设为false，使其永远不会暂停。
· 替换文件执行：通过Overrides功能，将修改后的JS文件保存到本地，替换原文件执行，彻底删除反调试代码。
· Burp Suite修改响应：拦截服务器返回的JS文件，使用Burp的Match and Replace功能替换掉反调试代码。
· 油猴插件配合Hook：编写Tampermonkey脚本，在页面加载前Hook反调试函数（如重写debugger、禁用事件监听等）。

例如，针对无限debugger，我们可以通过禁用所有断点快速跳过；若想永久移除，可使用Overrides将修改后的JS保存并替换。

四、总结与展望

JS逆向是Web安全测试中不可或缺的技能。通过熟练运用开发者工具，我们可以分析加密算法、发现敏感信息泄露，进而深入挖掘系统漏洞。同时，面对日益复杂的反调试技术，掌握多种绕过手段能够让我们在逆向过程中更加游刃有余。

需要注意的是，JS逆向技术应仅用于合法授权的安全测试和学习研究，切勿用于非法攻击。随着前端安全防护的不断加强，逆向与反逆向的博弈将持续演进，保持学习和实践才能立于不败之地。
