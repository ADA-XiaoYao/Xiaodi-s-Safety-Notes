å¼•è¨€ï¼šç°ä»£å‰ç«¯å·¥ç¨‹åŒ–çš„åŒåˆƒå‰‘

åœ¨å½“ä»Šå¿«é€Ÿå‘å±•çš„Webå¼€å‘é¢†åŸŸï¼ŒWebpackå·²æˆä¸ºå‰ç«¯å·¥ç¨‹åŒ–çš„æ ¸å¿ƒå·¥å…·ã€‚å®ƒé€šè¿‡æ¨¡å—åŒ–æ‰“åŒ…ã€ä»£ç ä¼˜åŒ–å’Œèµ„æºç®¡ç†ï¼Œæå¤§åœ°æå‡äº†å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚ç„¶è€Œï¼Œè¿™ç§å¼ºå¤§çš„æ„å»ºèƒ½åŠ›èƒŒåï¼Œå´éšè—ç€ä¸å®¹å¿½è§†çš„å®‰å…¨é£é™©â€”â€”ç‰¹åˆ«æ˜¯æºç æ³„æ¼é—®é¢˜ã€‚æœ¬æ–‡å°†ä»ç†è®ºåˆ°å®è·µï¼Œæ·±å…¥æ¢è®¨Webpackçš„æ‰“åŒ…æœºåˆ¶åŠå…¶å®‰å…¨å½±å“ã€‚

ä¸€ã€Webpackæ ¸å¿ƒæœºåˆ¶ä¸æ‰“åŒ…æ¨¡å¼å·®å¼‚

1.1 Webpackçš„æ¨¡å—åŒ–å“²å­¦

Webpackçš„æ ¸å¿ƒåˆ›æ–°åœ¨äºå°†å‰ç«¯å¼€å‘ä»ä¼ ç»Ÿçš„â€œæ–‡ä»¶é›†åˆâ€è½¬å˜ä¸ºâ€œæ¨¡å—ä¾èµ–å›¾â€ã€‚æ¯ä¸ªæ–‡ä»¶è¢«è§†ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œæ¨¡å—é—´çš„ä¾èµ–å…³ç³»æ„æˆäº†ä¸€å¼ å¤æ‚çš„å›¾ç»“æ„ã€‚è¿™ç§è®¾è®¡ä½¿å¾—Webpackèƒ½å¤Ÿï¼š

Â· é™æ€åˆ†æä¾èµ–ï¼šæ„å»ºæ—¶è§£ææ‰€æœ‰require/importè¯­å¥
Â· æŒ‰éœ€åŠ è½½ï¼šé€šè¿‡ä»£ç åˆ†å‰²å®ç°æ‡’åŠ è½½ä¼˜åŒ–
Â· èµ„æºç»Ÿä¸€å¤„ç†ï¼šå°†CSSã€å›¾ç‰‡ç­‰éJSèµ„æºä¹Ÿçº³å…¥æ¨¡å—ç³»ç»Ÿ

```javascript
// webpack.config.js åŸºç¡€é…ç½®ç¤ºä¾‹
module.exports = {
  entry: './src/index.js', // å…¥å£èµ·ç‚¹
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js'
  },
  mode: 'development', // æˆ– 'production'
  module: {
    rules: [
      { test: /\.css$/, use: ['style-loader', 'css-loader'] },
      { test: /\.js$/, exclude: /node_modules/, use: 'babel-loader' }
    ]
  }
};
```

1.2 æ‰“åŒ…æ¨¡å¼æ·±åº¦è§£æ

å¼€å‘æ¨¡å¼ï¼ˆdevelopmentï¼‰ vs ç”Ÿäº§æ¨¡å¼ï¼ˆproductionï¼‰

å¼€å‘æ¨¡å¼ç‰¹ç‚¹ï¼š

Â· å¯ç”¨NamedChunksPluginå’ŒNamedModulesPlugin
Â· ä¿ç•™å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼ˆsource mapã€å˜é‡åã€æ³¨é‡Šï¼‰
Â· ä¸è¿›è¡Œä»£ç å‹ç¼©å’ŒTree Shaking
Â· å¯ç”¨çƒ­æ¨¡å—æ›¿æ¢(HMR)

ç”Ÿäº§æ¨¡å¼ç‰¹ç‚¹ï¼š

Â· å¯ç”¨TerserPluginè¿›è¡Œä»£ç å‹ç¼©
Â· å¯ç”¨ModuleConcatenationPluginï¼ˆä½œç”¨åŸŸæå‡ï¼‰
Â· å¯ç”¨FlagDependencyUsagePluginï¼ˆTree Shakingï¼‰
Â· ç§»é™¤æ‰€æœ‰è°ƒè¯•ä¿¡æ¯

```javascript
// package.jsonè„šæœ¬é…ç½®
{
  "scripts": {
    "dev": "webpack --mode=development",
    "build": "webpack --mode=production"
  }
}
```

1.3 æ‰“åŒ…ä»£ç å·®å¼‚å¯¹æ¯”

å¼€å‘ç¯å¢ƒè¾“å‡ºç¤ºä¾‹ï¼š

```javascript
/***/ "./src/moduleA.js":
/*!************************!*\
  !*** ./src/moduleA.js ***!
  \************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {
"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"default\", function() { return moduleA; });\nfunction moduleA() {\n  console.log('Module A loaded');\n}\n\n//# sourceURL=webpack:///./src/moduleA.js?");
/***/ })
```

ç”Ÿäº§ç¯å¢ƒè¾“å‡ºç¤ºä¾‹ï¼š

```javascript
!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t){console.log("Hello Webpack")}]);
```

äºŒã€æºç æ³„æ¼ï¼šWebpackçš„å®‰å…¨ç›²åŒº

2.1 Source Mapæœºåˆ¶çš„å®‰å…¨é£é™©

Source Mapä½œä¸ºå¼€å‘è°ƒè¯•çš„åˆ©å™¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸å½“ä¼šæˆä¸ºä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼š

```javascript
// å±é™©é…ç½®ç¤ºä¾‹
module.exports = {
  mode: 'production',
  devtool: 'source-map', // ç”Ÿæˆå®Œæ•´æºç æ˜ å°„
  // æˆ–
  devtool: 'cheap-module-source-map' // ç”Ÿæˆç®€åŒ–çš„æºç æ˜ å°„
};

// å®‰å…¨é…ç½®ç¤ºä¾‹
module.exports = {
  mode: 'production',
  devtool: false, // ä¸ç”Ÿæˆsource map
  // æˆ–ä»…ç”¨äºé”™è¯¯è¿½è¸ª
  devtool: 'nosources-source-map' // ç”Ÿæˆä¸åŒ…å«æºç çš„source map
};
```

2.2 æºç æ³„æ¼çš„å¤šç§åœºæ™¯

åœºæ™¯ä¸€ï¼šå¼€å‘é…ç½®è¯¯ç”¨äºç”Ÿäº§

```javascript
// vue.config.js é”™è¯¯é…ç½®
export default defineConfig({
  build: {
    sourcemap: true, // ç”Ÿäº§ç¯å¢ƒå¼€å¯source map
  }
})
```

åœºæ™¯äºŒï¼šæ‰“åŒ…æ–‡ä»¶æœªæ¸…ç†

```dist/
â”œâ”€â”€ app.js
â”œâ”€â”€ app.js.map     â† æ³„æ¼çš„æºç æ˜ å°„æ–‡ä»¶
â”œâ”€â”€ vendor.js
â””â”€â”€ vendor.js.map â† æ³„æ¼çš„æºç æ˜ å°„æ–‡ä»¶
```

åœºæ™¯ä¸‰ï¼š.gitignoreé…ç½®ä¸å½“

```gitignore
# é”™è¯¯çš„å¿½ç•¥é…ç½®
!.gitignore
!README.md
# ç¼ºå¤±å¯¹æ„å»ºäº§ç‰©çš„å¿½ç•¥
# !dist/*.map  â† åº”æ·»åŠ æ­¤è¡Œ
```

2.3 æºç è¿˜åŸæŠ€æœ¯å®è·µ

æ”»å‡»è€…åˆ©ç”¨æ³„æ¼çš„source mapå¯ä»¥å®Œå…¨è¿˜åŸæºç ï¼š

```bash
# ä½¿ç”¨shujiè¿˜åŸæºç 
npm install -g shuji
shuji app.js.map -o extracted_src

# ä½¿ç”¨reverse-sourcemapè¿˜åŸ
npm install -g reverse-sourcemap
reverse-sourcemap --output-dir ./source_code app.js.map
```

è¿˜åŸåçš„ç›®å½•ç»“æ„ï¼š

```
extracted_src/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Login.vue
â”‚   â”‚   â””â”€â”€ Dashboard.vue
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ api.js
â”‚   â””â”€â”€ App.vue
â”œâ”€â”€ node_modules/
â”‚   â””â”€â”€ ...ï¼ˆä¾èµ–æºç ï¼‰
â””â”€â”€ webpack.config.js
```

ä¸‰ã€Vue.jsé¡¹ç›®å®‰å…¨å®è·µæ¡ˆä¾‹

3.1 Vueé¡¹ç›®æ„å»ºä¸å®‰å…¨é…ç½®

```javascript
// æ­£ç¡®çš„vue.config.jsé…ç½®
const { defineConfig } = require('@vue/cli-service')

module.exports = defineConfig({
  transpileDependencies: true,
  productionSourceMap: false, // å…³é”®ï¼šç”Ÿäº§ç¯å¢ƒå…³é—­source map
  
  // å®‰å…¨ç›¸å…³é…ç½®
  configureWebpack: {
    devtool: process.env.NODE_ENV === 'development' 
      ? 'cheap-module-source-map' 
      : false,
    
    optimization: {
      minimizer: [
        new TerserPlugin({
          terserOptions: {
            compress: {
              drop_console: true, // ç§»é™¤consoleè¯­å¥
              drop_debugger: true // ç§»é™¤debuggerè¯­å¥
            }
          }
        })
      ]
    }
  }
})
```

3.2 XSSæ¼æ´æ¡ˆä¾‹ä¸ä¿®å¤

æ¼æ´ä»£ç ç¤ºä¾‹ï¼š

```vue
<template>
  <div>
    <h1>XSSæ¼æ´æ¼”ç¤º</h1>
    <input v-model="userInput" placeholder="è¾“å…¥å†…å®¹" />
    <button @click="showContent">æ˜¾ç¤º</button>
    <div v-html="displayContent"></div> <!-- å±é™©ï¼šç›´æ¥æ¸²æŸ“HTML -->
  </div>
</template>

<script>
export default {
  data() {
    return {
      userInput: '',
      displayContent: ''
    }
  },
  methods: {
    showContent() {
      this.displayContent = this.userInput // ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥
    }
  }
}
</script>
```

å®‰å…¨ä¿®å¤æ–¹æ¡ˆï¼š

```vue
<template>
  <div>
    <h1>å®‰å…¨çš„XSSé˜²æŠ¤æ¼”ç¤º</h1>
    <input v-model="userInput" placeholder="è¾“å…¥å†…å®¹" />
    <button @click="showContent">æ˜¾ç¤º</button>
    
    <!-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ–‡æœ¬æ’å€¼ï¼ˆè‡ªåŠ¨è½¬ä¹‰ï¼‰ -->
    <div>{{ displayContent }}</div>
    
    <!-- æ–¹æ¡ˆ2ï¼šå¦‚éœ€HTMLï¼Œä½¿ç”¨å‡€åŒ–åº“ -->
    <div v-html="sanitizedContent"></div>
  </div>
</template>

<script>
import DOMPurify from 'dompurify'

export default {
  data() {
    return {
      userInput: '',
      displayContent: '',
      sanitizedContent: ''
    }
  },
  methods: {
    showContent() {
      // ä½¿ç”¨DOMPurifyè¿›è¡Œå‡€åŒ–
      this.sanitizedContent = DOMPurify.sanitize(this.userInput)
      
      // æˆ–ç›´æ¥ä½¿ç”¨æ–‡æœ¬æ’å€¼
      this.displayContent = this.userInput
    }
  }
}
</script>
```

3.3 å®Œæ•´çš„å®‰å…¨æ„å»ºæµç¨‹

```bash
# 1. åˆ›å»ºVueé¡¹ç›®ï¼ˆä½¿ç”¨æœ€æ–°å®‰å…¨æ¨¡æ¿ï¼‰
npm create vue@latest my-secure-app -- --typescript --router --pinia --eslint

# 2. å®‰è£…å®‰å…¨ç›¸å…³ä¾èµ–
cd my-secure-app
npm install dompurify vue-dompurify-html
npm install --save-dev webpack-bundle-analyzer compression-webpack-plugin

# 3. é…ç½®å®‰å…¨æ£€æŸ¥è„šæœ¬
// package.json
{
  "scripts": {
    "build": "vue-cli-service build",
    "build:analyze": "vue-cli-service build --report",
    "security:scan": "npx audit-ci --critical",
    "predeploy": "npm run security:scan && npm run build"
  }
}

# 4. æ·»åŠ å®‰å…¨å¤´é…ç½®
// åœ¨nginxæˆ–æœåŠ¡å™¨é…ç½®ä¸­
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
```

å››ã€ä¼ä¸šçº§å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

4.1 CI/CDæµæ°´çº¿å®‰å…¨é›†æˆ

```yaml
# .gitlab-ci.yml å®‰å…¨æ„å»ºé…ç½®
stages:
  - security
  - build
  - deploy

security_scan:
  stage: security
  script:
    - npm ci
    - npm audit --audit-level=high
    - npx sourcemap-detector dist/*.map || true
    - |
      if [ -d "dist" ]; then
        find dist -name "*.map" | grep . && echo "WARNING: Source maps found!" && exit 1
      fi

build_production:
  stage: build
  script:
    - npm run build
    - rm -f dist/*.map  # å¼ºåˆ¶åˆ é™¤source map
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

deploy_production:
  stage: deploy
  script:
    - ./deploy.sh
  only:
    - main
```

4.2 ç›‘æ§ä¸åº”æ€¥å“åº”

```javascript
// æºç æ³„æ¼ç›‘æ§è„šæœ¬
const fs = require('fs')
const path = require('path')
const https = require('https')

class SourceMapMonitor {
  constructor(config) {
    this.projectName = config.projectName
    this.webhookUrl = config.webhookUrl
  }
  
  scanDirectory(dirPath) {
    const files = fs.readdirSync(dirPath)
    let sourceMapFound = false
    
    files.forEach(file => {
      const fullPath = path.join(dirPath, file)
      const stat = fs.statSync(fullPath)
      
      if (stat.isDirectory()) {
        this.scanDirectory(fullPath)
      } else if (file.endsWith('.map')) {
        console.error(`âš ï¸  Source map detected: ${fullPath}`)
        sourceMapFound = true
        
        // å‘é€å‘Šè­¦
        this.sendAlert(fullPath)
        
        // å¯é€‰ï¼šè‡ªåŠ¨åˆ é™¤
        if (process.env.AUTO_REMOVE === 'true') {
          fs.unlinkSync(fullPath)
          console.log(`ğŸ—‘ï¸  Removed: ${fullPath}`)
        }
      }
    })
    
    return sourceMapFound
  }
  
  sendAlert(filePath) {
    const message = {
      text: `ğŸš¨ æºç æ³„æ¼å‘Šè­¦\né¡¹ç›®: ${this.projectName}\næ–‡ä»¶: ${filePath}\næ—¶é—´: ${new Date().toISOString()}`
    }
    
    // å‘é€åˆ°ä¼ä¸šå¾®ä¿¡/Slackç­‰
    if (this.webhookUrl) {
      const req = https.request(this.webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      req.write(JSON.stringify(message))
      req.end()
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const monitor = new SourceMapMonitor({
  projectName: 'my-vue-app',
  webhookUrl: process.env.SECURITY_WEBHOOK
})

// åœ¨æ„å»ºåè¿è¡Œæ‰«æ
if (process.env.NODE_ENV === 'production') {
  const hasSourceMap = monitor.scanDirectory('./dist')
  if (hasSourceMap) {
    process.exit(1) // æ„å»ºå¤±è´¥
  }
}
```

äº”ã€æ€»ç»“ä¸æœ€ä½³å®è·µ

5.1 Webpackå®‰å…¨é…ç½®æ¸…å•

1. ç”Ÿäº§ç¯å¢ƒå¿…é¡»å…³é—­source map
   ```javascript
   productionSourceMap: false
   ```
2. å¯ç”¨ä»£ç å‹ç¼©å’Œæ··æ·†
   ```javascript
   new TerserPlugin({
     terserOptions: {
       mangle: true,
       compress: { drop_console: true }
     }
   })
   ```
3. ä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶é…ç½®
   ```javascript
   devtool: process.env.NODE_ENV === 'development' 
     ? 'cheap-module-source-map' 
     : false
   ```
4. å®šæœŸæ›´æ–°ä¾èµ–
   ```bash
   npm audit fix --force
   ```

5.2 ç»„ç»‡çº§å®‰å…¨å»ºè®®

1. å»ºç«‹å®‰å…¨ç¼–ç è§„èŒƒ
   Â· ç¦æ­¢åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨eval()ã€Function()æ„é€ å‡½æ•°
   Â· å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯å’Œè½¬ä¹‰
   Â· ä½¿ç”¨CSPï¼ˆå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰
2. å®æ–½è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥
   Â· åœ¨CI/CDæµæ°´çº¿é›†æˆå®‰å…¨æ‰«æ
   Â· å®šæœŸè¿›è¡Œæºç å®¡è®¡å’Œä¾èµ–æ£€æŸ¥
   Â· ç›‘æ§ç”Ÿäº§ç¯å¢ƒå¼‚å¸¸è¡Œä¸º
3. åˆ¶å®šåº”æ€¥å“åº”æµç¨‹
   Â· å‘ç°æºç æ³„æ¼æ—¶çš„å¤„ç†æµç¨‹
   Â· å®¢æˆ·æ•°æ®æ³„éœ²çš„åº”æ€¥é¢„æ¡ˆ
   Â· å®‰å…¨æ¼æ´çš„ä¿®å¤å’Œé€šå‘Šæœºåˆ¶

5.3 æœªæ¥è¶‹åŠ¿ä¸å±•æœ›

éšç€å‰ç«¯æŠ€æœ¯çš„å‘å±•ï¼Œæ–°çš„æ„å»ºå·¥å…·ï¼ˆå¦‚Viteã€esbuildï¼‰æ­£åœ¨é€æ¸æ™®åŠï¼Œå®ƒä»¬åœ¨è®¾è®¡ä¸Šæ›´åŠ æ³¨é‡å®‰å…¨æ€§ã€‚ç„¶è€Œï¼Œæ— è®ºå·¥å…·å¦‚ä½•æ¼”å˜ï¼Œå®‰å…¨çš„åŸºæœ¬åŸåˆ™ä¸å˜ï¼š

1. æœ€å°æƒé™åŸåˆ™ï¼šåªæš´éœ²å¿…è¦çš„æºç ä¿¡æ¯
2. æ·±åº¦é˜²å¾¡ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤æªæ–½
3. æŒç»­ç›‘æ§ï¼šå®æ—¶æ£€æµ‹å®‰å…¨å¨èƒ
4. å¿«é€Ÿå“åº”ï¼šå»ºç«‹æœ‰æ•ˆçš„äº‹ä»¶å“åº”æœºåˆ¶

Webpackä½œä¸ºç°ä»£å‰ç«¯å¼€å‘çš„åŸºçŸ³ï¼Œå…¶å¼ºå¤§åŠŸèƒ½ä¸ºä¼ä¸šå¸¦æ¥äº†å·¨å¤§ä»·å€¼ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†æ–°çš„å®‰å…¨æŒ‘æˆ˜ã€‚åªæœ‰æ·±å…¥ç†è§£å…¶å·¥ä½œåŸç†ï¼Œé‡‡å–é€‚å½“çš„å®‰å…¨æªæ–½ï¼Œæ‰èƒ½åœ¨ä¸ç‰ºç‰²å¼€å‘æ•ˆç‡çš„å‰æä¸‹ï¼Œç¡®ä¿åº”ç”¨çš„å®‰å…¨æ€§ã€‚åœ¨è¿½æ±‚æŠ€æœ¯åˆ›æ–°çš„é“è·¯ä¸Šï¼Œå®‰å…¨æ°¸è¿œä¸åº”æ˜¯äº‹åè€ƒè™‘çš„äº‹é¡¹ï¼Œè€Œåº”æ˜¯è´¯ç©¿å§‹ç»ˆçš„æ ¸å¿ƒè¦ç´ ã€‚
